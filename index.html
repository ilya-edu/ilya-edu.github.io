<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CNC Монитор — интерактивный дашборд</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;color-scheme: dark}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%, #0b1220 100%);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:22px auto;padding:18px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{color:#e6eef6;font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#042029;font-weight:600;cursor:pointer}
    button:active{transform:translateY(1px)}
    .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px;margin-top:14px;color:#dbeafe}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .full{grid-column:1/-1}
    .chart-wrap{padding:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:10px}
    label{font-size:12px;color:var(--muted)}
    input[type=text]{width:420px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef6}
    table{width:100%;border-collapse:collapse}
    td,th{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
    .meta{display:flex;gap:12px;flex-wrap:wrap}
    footer{color:var(--muted);font-size:12px;margin-top:10px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}.controls{flex-direction:column;align-items:flex-start}input[type=text]{width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Монитор CNC — интерактивные графики</h1>
      <div class="controls">
        <label for="programName">Название программы</label>
        <input id="programName" type="text" readonly title="Название текущей программы" />
        <button id="refreshBtn">Обновить данные</button>
      </div>
    </header>

    <div class="card">
      <div class="grid">
        <div class="chart-wrap">
          <canvas id="completionPie"></canvas>
        </div>
        <div class="chart-wrap">
          <canvas id="coreTimesBar"></canvas>
        </div>

        <div class="chart-wrap">
          <canvas id="channelTimesHist"></canvas>
        </div>

        <div class="chart-wrap">
          <canvas id="axesBar"></canvas>
        </div>

        <div class="chart-wrap full">
          <h3 style="margin:6px 0 8px 0">Текстовые данные / Сводка</h3>
          <div id="rawTable"></div>
        </div>
      </div>
    </div>

    <footer>Кнопка <strong>Обновить данные</strong> делает GET-запрос на <code>https://cnc.kovalev.team/get/3</code>. Если сервер блокирует CORS — появится сообщение об ошибке и останутся локальные тестовые данные.</footer>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // --- Пример данных (тот JSON, который вы прислали) — используется как начальная загрузка и fallback ---
    const sampleJSON = {"data":[["Моточасы",[["Время работы ядра (всего)","26:40:32"],["Время работы ядра (текущее)","7:9:3"],["Количество перезапусков ядра","86"],["Количество каналов","2"]]],["Канал 1",[["Время работы канала (всего)","4:54:44"],["Время работы канала (текущее)","4:27:12"],["Статус канала","Работа"],["Режим канала","Авто"],["Время работы программы","000:02:17"],["Процент выполнения программы","86%"],["Программа","/NC/examples/04_06.nc"]]],["Оси Канала 1",[["Перемещение по оси X","42,8099 мм"],["Перемещение по оси Y","-50,5937 мм"],["Перемещение по оси Z","0 мм"],["Перемещение по оси C","34,4552 мм"],["Перемещение по оси S2","-5072,3452 мм"]]],["Оси Канала 2",[["Перемещение по оси X","0 мм"],["Перемещение по оси Y","0 мм"],["Перемещение по оси Z","0 мм"],["Перемещение по оси S","0 мм"],["Перемещение по оси S2","0 мм"]]]]};

    // --- Утилиты для парсинга ---
    function timeToSeconds(t){
      // t может быть в формате H:M:S или 000:02:17
      if(!t) return 0;
      const parts = t.split(':').map(p=>parseInt(p,10)||0);
      if(parts.length===3) return parts[0]*3600 + parts[1]*60 + parts[2];
      if(parts.length===2) return parts[0]*60 + parts[1];
      return parseInt(t,10)||0;
    }

    function parseNumberFromAxis(s){
      // Преобразует строки типа "42,8099 мм" или "-50,5937 мм" в число
      if(!s) return 0;
      const m = s.replace('мм','').replace('mm','').trim().replace(',','.');
      const n = parseFloat(m);
      return isFinite(n)?n:0;
    }

    // --- Функция, которая берет структуру data и возвращает удобный объект ---
    function normalize(json){
      const out = {core:{},channels:[],axes:[]};
      for(const section of json.data){
        const name = section[0];
        const rows = section[1];
        if(name === 'Моточасы'){
          for(const r of rows){ out.core[r[0]] = r[1]; }
        } else if(name.startsWith('Канал')){
          const ch = {name,props:{}};
          for(const r of rows){ ch.props[r[0]] = r[1]; }
          out.channels.push(ch);
        } else if(name.startsWith('Оси')){
          const ax = {name,props:{}};
          for(const r of rows){ ax.props[r[0]] = r[1]; }
          out.axes.push(ax);
        }
      }
      return out;
    }

    // --- Инициализация графиков Chart.js ---
    const ctxPie = document.getElementById('completionPie').getContext('2d');
    const ctxCoreBar = document.getElementById('coreTimesBar').getContext('2d');
    const ctxHist = document.getElementById('channelTimesHist').getContext('2d');
    const ctxAxes = document.getElementById('axesBar').getContext('2d');

    // Create charts with empty data
    const pieChart = new Chart(ctxPie, {
      type: 'doughnut',
      data: {labels:['Выполнено','Осталось'],datasets:[{data:[1,1],label:'Прогресс'}]},
      options: {plugins:{legend:{position:'bottom'}},responsive:true}
    });

    const coreBar = new Chart(ctxCoreBar, {
      type: 'bar',
      data: {labels:['Время ядра (всего ч)','Время ядра (текущее ч)'],datasets:[{label:'Часы',data:[1,1]}]},
      options: {scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}},responsive:true}
    });

    const histChart = new Chart(ctxHist, {
      type: 'bar',
      data:{labels:[],datasets:[{label:'Время программы (сек)',data:[]}]},
      options:{scales:{y:{beginAtZero:true}},responsive:true}
    });

    const axesChart = new Chart(ctxAxes, {
      type: 'bar',
      data:{labels:[],datasets:[{label:'Позиция (мм)',data:[]}]},
      options:{scales:{y:{beginAtZero:false}},responsive:true}
    });

    // --- Функция обновления визуализации по объекту ---
    function renderFromJSON(json){
      try{
        const norm = normalize(json);
        // Название программы (берём из первого канала, поле "Программа")
        const programName = (norm.channels[0] && norm.channels[0].props['Программа']) || '';
        document.getElementById('programName').value = programName;

        // Процент выполнения
        const pctRaw = (norm.channels[0] && norm.channels[0].props['Процент выполнения программы']) || '0%';
        const pct = parseFloat(pctRaw.toString().replace('%','')) || 0;
        pieChart.data.datasets[0].data = [pct, Math.max(0,100-pct)];
        pieChart.data.labels = ['Выполнено (%)','Осталось (%)'];
        pieChart.update();

        // Core times -> переводим в часы (float)
        const totalCoreSec = timeToSeconds(norm.core['Время работы ядра (всего)']);
        const currCoreSec  = timeToSeconds(norm.core['Время работы ядра (текущее)']);
        const totalCoreH = +(totalCoreSec/3600).toFixed(2);
        const currCoreH  = +(currCoreSec/3600).toFixed(2);
        coreBar.data.datasets[0].data = [totalCoreH,currCoreH];
        coreBar.update();

        // Channel program times (в секундах) — строим гистограмму для всех каналов
        const labels = [];
        const dataSec = [];
        for(const ch of norm.channels){
          const prgTime = ch.props['Время работы программы'] || ch.props['Время работы канала (текущее)'] || '0:0:0';
          const sec = timeToSeconds(prgTime);
          labels.push(ch.name);
          dataSec.push(sec);
        }
        histChart.data.labels = labels;
        histChart.data.datasets[0].data = dataSec;
        histChart.update();

        // Axes: возьмём Оси Канала 1 (если есть) и выведем перемещения
        const axes = (norm.axes.length>0)?norm.axes[0].props:{};
        const axesLabels = [];
        const axesValues = [];
        for(const k in axes){ axesLabels.push(k); axesValues.push(parseNumberFromAxis(axes[k])); }
        axesChart.data.labels = axesLabels;
        axesChart.data.datasets[0].data = axesValues;
        axesChart.update();

        // Текстовая таблица
        const tableHolder = document.getElementById('rawTable');
        let html = '<table><thead><tr><th>Раздел</th><th>Параметр</th><th>Значение</th></tr></thead><tbody>';
        for(const section of json.data){
          const sname = section[0];
          for(const row of section[1]){
            html += `<tr><td>${sname}</td><td>${row[0]}</td><td>${row[1]}</td></tr>`;
          }
        }
        html += '</tbody></table>';
        tableHolder.innerHTML = html;

      } catch(e){
        console.error('Ошибка рендеринга:',e);
        alert('Ошибка при обработке данных: '+e.message);
      }
    }

    // --- Инициализация: отрисуем sampleJSON ---
    renderFromJSON(sampleJSON);

    // --- Fetch logic при клике на кнопку ---
    document.getElementById('refreshBtn').addEventListener('click', async()=>{
      const url = 'https://cnc.kovalev.team/get/3';
      document.getElementById('refreshBtn').disabled = true;
      document.getElementById('refreshBtn').textContent = 'Загрузка...';
      try{
        const resp = await fetch(url, {cache: 'no-store'});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const data = await resp.json();
        // Предполагается, что server возвращает ту же структуру {data: [...]}
        renderFromJSON(data);
      }catch(err){
        console.warn('Не удалось получить данные с сервера:',err);
        alert('Ошибка при обращении к серверу: '+err.message+'\nБудут показаны локальные данные.\n(Возможная причина — CORS или недоступность хоста)');
        renderFromJSON(sampleJSON);
      } finally{
        document.getElementById('refreshBtn').disabled = false;
        document.getElementById('refreshBtn').textContent = 'Обновить данные';
      }
    });

  </script>
</body>
</html>
