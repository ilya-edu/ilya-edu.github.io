<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мониторинг оборудования</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .chart-container {
            width: 45%;
            min-width: 300px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        #programName {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Мониторинг оборудования</h1>
    <div>
        <label for="programName">Название программы:</label>
        <input type="text" id="programName" readonly>
    </div>
    <button id="refreshBtn">Обновить данные</button>

    <div class="container">
        <div class="chart-container">
            <canvas id="coreTimeChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="channelStatusChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="axisMovementChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="programProgressChart"></canvas>
        </div>
    </div>

    <script>
        // Исходный JSON
        const rawData = {
            "data":[
                ["Моточасы",[
                    ["Время работы ядра (всего)","26:40:32"],
                    ["Время работы ядра (текущее)","7:9:3"],
                    ["Количество перезапусков ядра","86"],
                    ["Количество каналов","2"]
                ]],
                ["Канал 1",[
                    ["Время работы канала (текущее)","4:27:12"],
                    ["Статус канала","Работа"],
                    ["Режим канала","Авто"],
                    ["Время работы программы","000:02:17"],
                    ["Процент выполнения программы","86%"],
                    ["Программа","/NC/examples/04_06.nc"]
                ]],
                ["Оси Канала 1",[
                    ["Перемещение по оси X","42,8099 мм"],
                    ["Перемещение по оси Y","-50,5937 мм"],
                    ["Перемещение по оси Z","0 мм"],
                    ["Перемещение по оси C","34,4552 мм"],
                    ["Перемещение по оси S2","-5072,3452 мм"]
                ]],
                ["Оси Канала 2",[
                    ["Перемещение по оси X","0 мм"],
                    ["Перемещение по оси Y","0 мм"],
                    ["Перемещение по оси Z","0 мм"],
                    ["Перемещение по оси S","0 мм"],
                    ["Перемещение по оси S2","0 мм"]
                ]]
            ]
        };

        // Парсинг JSON
        function parseData(data) {
            const result = {};
            data.data.forEach(item => {
                const [title, values] = item;
                result[title] = {};
                values.forEach(([key, value]) => {
                    result[title][key] = value;
                });
            });
            return result;
        }

        // Обновление графиков
        function updateCharts() {
            const data = parseData(rawData);

            // Название программы
            document.getElementById('programName').value = data['Канал 1']['Программа'];

            // 1. Моточасы (круговая диаграмма)
            const coreTimeCtx = document.getElementById('coreTimeChart').getContext('2d');
            const totalTime = data['Моточасы']['Время работы ядра (всего)'];
            const currentTime = data['Моточасы']['Время работы ядра (текущее)'];
            const restarts = data['Моточасы']['Количество перезапусков ядра'];

            if (window.coreTimeChart) {
                window.coreTimeChart.destroy();
            }
            window.coreTimeChart = new Chart(coreTimeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Время работы (текущее)', 'Время работы (всего)', 'Перезапуски'],
                    datasets: [{
                        data: [
                            timeToMinutes(currentTime),
                            timeToMinutes(totalTime),
                            parseInt(restarts)
                        ],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Моточасы и перезапуски'
                        }
                    }
                }
            });

            // 2. Статус канала (столбчатая диаграмма)
            const channelStatusCtx = document.getElementById('channelStatusChart').getContext('2d');
            const channelStatus = data['Канал 1']['Статус канала'];
            const channelMode = data['Канал 1']['Режим канала'];

            if (window.channelStatusChart) {
                window.channelStatusChart.destroy();
            }
            window.channelStatusChart = new Chart(channelStatusCtx, {
                type: 'bar',
                data: {
                    labels: ['Статус', 'Режим'],
                    datasets: [{
                        label: 'Канал 1',
                        data: [channelStatus === 'Работа' ? 1 : 0, channelMode === 'Авто' ? 1 : 0],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Статус и режим канала'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });

            // 3. Перемещение по осям (линейная диаграмма)
            const axisMovementCtx = document.getElementById('axisMovementChart').getContext('2d');
            const axes = Object.keys(data['Оси Канала 1']).filter(k => k.startsWith('Перемещение по оси'));
            const values = axes.map(axis => parseFloat(data['Оси Канала 1'][axis]));

            if (window.axisMovementChart) {
                window.axisMovementChart.destroy();
            }
            window.axisMovementChart = new Chart(axisMovementCtx, {
                type: 'line',
                data: {
                    labels: axes.map(axis => axis.replace('Перемещение по оси ', '')),
                    datasets: [{
                        label: 'Перемещение (мм)',
                        data: values,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Перемещение по осям (Канал 1)'
                        }
                    }
                }
            });

            // 4. Прогресс программы (круговая диаграмма)
            const programProgressCtx = document.getElementById('programProgressChart').getContext('2d');
            const progress = parseInt(data['Канал 1']['Процент выполнения программы']);

            if (window.programProgressChart) {
                window.programProgressChart.destroy();
            }
            window.programProgressChart = new Chart(programProgressCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Выполнено', 'Осталось'],
                    datasets: [{
                        data: [progress, 100 - progress],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(200, 200, 200, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Прогресс выполнения программы'
                        }
                    }
                }
            });
        }

        // Вспомогательная функция: время в минуты
        function timeToMinutes(timeStr) {
            const parts = timeStr.split(':').map(Number);
            return parts[0] * 60 + parts[1] + (parts[2] || 0) / 60;
        }

        // Инициализация
        document.getElementById('refreshBtn').addEventListener('click', updateCharts);
        updateCharts();
    </script>
</body>
</html>
